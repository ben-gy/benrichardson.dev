<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Ben Richardson - Indie hacker, aerospace engineer, full-stack founder based in Canberra/Melbourne, Australia">
    <title>Ben Richardson</title>
    <link rel="stylesheet" href="style.css">
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <!-- Apple Touch Icon (home screen) -->
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <!-- Apple Web App -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Ben Richardson">
    <!-- Apple Splash Screens -->
    <link rel="apple-touch-startup-image" href="splash/iphone-8.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="splash/iphone-12.png" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="splash/iphone-14-pro.png" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="splash/iphone-14-pro-max.png" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3)">
    <style>
        /* Disable text selection highlighting */
        ::selection {
            background: transparent;
        }
        ::-moz-selection {
            background: transparent;
        }
        /* Custom styles for interactive features */
        .apple-logo {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: url('icon/apple.svg') no-repeat center;
            background-size: contain;
            cursor: pointer;
            vertical-align: middle;
        }
        .apple-menu:focus .apple-logo,
        .apple-menu:active .apple-logo {
            filter: invert(1);
        }
        .window {
            position: absolute;
            cursor: default;
            z-index: 10;
        }
        .title-bar {
            cursor: grab;
        }
        .title-bar:active {
            cursor: grabbing;
        }
        .window.collapsed .window-pane,
        .window.collapsed .separator {
            display: none;
        }
        .hidden-dialog {
            display: none;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-overlay.visible {
            display: flex;
        }
        .modal-dialog {
            background: white;
            padding: 0;
        }
        .modal-contents {
            padding: 1.5rem;
            text-align: center;
        }
        .modal-contents p {
            margin: 0.5rem 0;
        }
        .alert-box {
            background: white;
        }
        .alert-contents {
            padding: 1rem;
            text-align: center;
        }
                .alert-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1rem;
        }
        .calculator-window {
            width: 180px;
        }
        .calc-display {
            background: white;
            border: 1px solid black;
            padding: 0.25rem 0.5rem;
            text-align: right;
            font-family: 'ChiKareGo2', monospace;
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }
        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2px;
        }
        .calc-buttons button {
            padding: 0.5rem;
            min-width: 0;
            width: 100%;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .fade-out {
            animation: fadeOut 0.5s forwards;
        }
        .fade-in {
            animation: fadeIn 0.3s forwards;
        }
        /* Startup screen */
        #startup-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            gap: 1rem;
        }
        #startup-screen.hidden {
            display: none;
        }
        .startup-icon {
            width: 64px;
            height: 64px;
        }
        .startup-text {
            font-family: 'ChicagoFLF', 'ChiKareGo2', monospace;
            font-size: 14px;
        }
        /* Menu bar clock */
        .menu-clock {
            margin-left: auto;
            padding: 6px 10px;
            cursor: pointer;
        }
        /* Desktop grid system */
        .desktop-grid {
            position: fixed;
            top: 28px; /* Below menu bar */
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1;
        }
        /* Desktop icons */
        .desktop-icon {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem;
            user-select: none;
            width: 80px;
            height: 80px;
            pointer-events: auto;
            box-sizing: border-box;
        }
        .desktop-icon:hover {
            background: rgba(0,0,0,0.1);
        }
        .desktop-icon.selected {
            background: black;
            color: white;
        }
        .desktop-icon.selected img {
            filter: invert(1);
        }
        .desktop-icon.dragging {
            opacity: 0.7;
            z-index: 5;
        }
        .desktop-icon img {
            width: 48px;
            height: 48px;
            image-rendering: pixelated;
        }
        .desktop-icon span {
            font-family: 'ChicagoFLF', 'ChiKareGo2', monospace;
            font-size: 12px;
            margin-top: 4px;
            text-align: center;
            white-space: nowrap;
        }
        .trash-icon.has-items img {
            transform: scale(1.1);
        }
        /* Lunar Lander */
        .lander-output {
            font-family: 'ChiKareGo2', monospace;
            font-size: 12px;
            border: 1px solid black;
            padding: 0.5rem;
            margin: 0 0 0.5rem 0;
            height: 160px;
            overflow-y: auto;
        }
        /* Star Trek */
        .startrek-window {
            width: 360px;
        }
        .startrek-output {
            font-family: 'ChiKareGo2', monospace;
            font-size: 10px;
            border: 1px solid black;
            padding: 0.5rem;
            margin: 0 0 0.5rem 0;
            height: 240px;
            overflow-y: auto;
            white-space: pre;
            line-height: 1.2;
        }
        /* Blackjack */
        .blackjack-window {
            width: 260px;
        }
        .blackjack-output {
            font-family: 'ChiKareGo2', monospace;
            font-size: 11px;
            border: 1px solid black;
            padding: 0.5rem;
            margin: 0 0 0.5rem 0;
            height: 180px;
            overflow-y: auto;
            white-space: pre;
            line-height: 1.3;
        }
        .blackjack-buttons {
            display: flex;
            gap: 4px;
            justify-content: center;
        }
        /* Mastermind */
        .mastermind-window {
            width: 280px;
        }
        .mastermind-output {
            font-family: 'ChiKareGo2', monospace;
            font-size: 11px;
            border: 1px solid black;
            padding: 0.5rem;
            margin: 0 0 0.5rem 0;
            height: 200px;
            overflow-y: auto;
            white-space: pre;
            line-height: 1.3;
        }
        /* Hamurabi */
        .hamurabi-window {
            width: 320px;
        }
        .hamurabi-output {
            font-family: 'ChiKareGo2', monospace;
            font-size: 11px;
            border: 1px solid black;
            padding: 0.5rem;
            margin: 0 0 0.5rem 0;
            height: 220px;
            overflow-y: auto;
            white-space: pre;
            line-height: 1.3;
        }
        /* Puzzle game */
        .puzzle-window {
            width: 200px;
        }
        .puzzle-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2px;
            background: black;
            padding: 2px;
        }
        .puzzle-tile {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'ChicagoFLF', 'ChiKareGo2', monospace;
            font-size: 1.2rem;
            font-weight: bold;
            background: white;
            border: 1px solid #999;
            cursor: pointer;
        }
        .puzzle-tile:hover {
            background: #eee;
        }
        .puzzle-tile.empty {
            background: #ccc;
            border: none;
            cursor: default;
        }
        .puzzle-controls {
            display: flex;
            justify-content: center;
            margin-top: 0.5rem;
        }
        /* Note Pad */
        .notepad-window {
            width: 280px;
        }
        .notepad-content {
            position: relative;
        }
        .notepad-textarea {
            width: 100%;
            height: 150px;
            border: 1px solid black;
            font-family: 'Geneva', 'ChiKareGo2', monospace;
            font-size: 12px;
            padding: 0.5rem;
            resize: none;
            box-sizing: border-box;
        }
        .notepad-corner {
            position: absolute;
            bottom: 5px;
            left: 5px;
            cursor: pointer;
            font-size: 1.2rem;
        }
        .notepad-page-num {
            text-align: center;
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }
        /* Email window */
        .email-window {
            width: 300px;
        }
        .email-window .window-pane {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .email-window textarea {
            width: 100%;
            height: 100px;
            border: 1px solid black;
            font-family: 'Geneva', 'ChiKareGo2', monospace;
            font-size: 12px;
            padding: 0.5rem;
            resize: none;
            box-sizing: border-box;
        }
        .email-window input[readonly] {
            background: #eee;
            cursor: pointer;
        }
        /* Sad Mac */
        .sad-mac-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            flex-direction: column;
            gap: 1rem;
        }
        .sad-mac-screen.visible {
            display: flex;
        }
                .sad-mac-code {
            color: #fff;
            font-family: 'ChicagoFLF', 'ChiKareGo2', monospace;
            font-size: 14px;
        }
        /* Scrolling credits */
        .credits-container {
            height: 80px;
            overflow: hidden;
            position: relative;
            border: 1px solid black;
            margin-top: 0.5rem;
        }
        .credits-scroll {
            position: absolute;
            width: 100%;
            animation: scrollCredits 25s linear infinite;
        }
        @keyframes scrollCredits {
            0% { top: 80px; }
            100% { top: -400px; }
        }
        /* Mobile responsive styles */
        @media (max-width: 480px) {
            html {
                overflow: hidden;
                height: 100%;
            }
            body {
                margin: 0;
                padding: 0;
                overflow: hidden;
                width: 100%;
                height: 100%;
                min-height: 100%;
                background-attachment: scroll;
            }
            .window {
                width: calc(100% - 2rem);
                max-width: none;
                overflow: hidden;
            }
            .window .title-bar {
                overflow: hidden;
            }
            .desktop-icon {
                display: none;
            }
            ul[role="menu-bar"] {
                overflow: visible;
                width: 100%;
                box-sizing: border-box;
            }
            ul[role="menu-bar"] > [role="menu-item"],
            .menu-clock {
                padding: 12px 12px;
                font-size: 16px;
            }
            /* Hide Edit and View menus on mobile */
            ul[role="menu-bar"] > [role="menu-item"]:nth-child(3),
            ul[role="menu-bar"] > [role="menu-item"]:nth-child(4) {
                display: none;
            }
            ul[role="menu-bar"] > [role="menu-item"]:first-child {
                padding-left: 16px;
            }
            .menu-clock {
                padding-right: 16px;
            }
            /* Mobile menu - toggle via JavaScript instead of :focus */
            ul[role="menu-bar"] > [role="menu-item"].menu-open > ul[role="menu"] {
                display: block;
            }
            .calculator-window,
            .puzzle-window,
            .notepad-window,
            .email-window,
            .search-window,
            .lander-window {
                width: calc(100% - 2rem) !important;
            }
        }
    </style>
</head>
<body>
    <!-- Startup Screen -->
    <div id="startup-screen">
        <img src="icon/apple.svg" alt="Apple" class="startup-icon">
        <div class="startup-text">Welcome to Macintosh.</div>
    </div>

    <!-- Sad Mac Screen -->
    <div class="sad-mac-screen" id="sad-mac-screen" onclick="this.classList.remove('visible')">
        <img src="icon/sad-mac.svg" alt="Sad Mac" style="width: 128px; height: 160px;">
        <div class="sad-mac-code">Sad Mac</div>
        <div class="sad-mac-code">Error Code: 0F0003</div>
        <div class="sad-mac-code" style="margin-top: 2rem; font-size: 12px;">(click to dismiss)</div>
    </div>

    <!-- Desktop Grid with Icons -->
    <div class="desktop-grid" id="desktop-grid">
        <div class="desktop-icon" id="hd-icon" style="right: 10px; top: 10px;" ondblclick="showMainWindow()">
            <img src="icon/mac-hd.svg" alt="HD">
            <span>Macintosh HD</span>
        </div>
        <div class="desktop-icon" id="email-icon" style="left: 10px; top: 10px;" ondblclick="toggleEmail()">
            <img src="icon/email.svg" alt="Email">
            <span>Email</span>
        </div>
        <div class="desktop-icon" id="internet-icon" style="left: 10px; top: 90px;" ondblclick="toggleSearch()">
            <img src="icon/internet.svg" alt="Internet">
            <span>Internet</span>
        </div>
        <div class="desktop-icon trash-icon" id="trash-icon" style="right: 10px; bottom: 10px;" ondblclick="emptyTrash()">
            <img src="icon/trash.svg" alt="Trash">
            <span>Trash</span>
        </div>
    </div>

    <!-- Menu Bar -->
    <ul role="menu-bar">
        <li role="menu-item" tabindex="0" aria-haspopup="true" class="apple-menu">
            <span class="apple-logo"></span>
            <ul role="menu">
                <li role="menu-item">
                    <a href="#" onclick="showAboutMac(event)">About This Mac</a>
                </li>
                <li class="divider"></li>
                <li role="menu-item">
                    <a href="#" onclick="restartSystem(); return false;">Restart</a>
                </li>
                <li role="menu-item">
                    <a href="#" onclick="shutDown(); return false;">Shut Down</a>
                </li>
            </ul>
        </li>
        <li role="menu-item" tabindex="0" aria-haspopup="true">
            File
            <ul role="menu">
                <li role="menu-item">
                    <a href="#" onclick="showAboutBen(event)">About Ben...</a>
                </li>
                <li class="divider"></li>
                <li role="menu-item">
                    <a href="#" onclick="toggleEmail(); return false;">Email...</a>
                </li>
                <li class="divider"></li>
                <li role="menu-item">
                    <a href="#" onclick="window.print(); return false;">Print...</a>
                </li>
                <li class="divider"></li>
                <li role="menu-item">
                    <a href="#" onclick="closeAllWindows(); return false;">Close All Windows</a>
                </li>
            </ul>
        </li>
        <li role="menu-item" tabindex="0" aria-haspopup="true">
            Edit
            <ul role="menu">
                <li role="menu-item">
                    <a href="#" onclick="navigator.clipboard.writeText('hi@benrichardson.dev'); showAlert('Email copied to clipboard!'); return false;">Copy Email</a>
                </li>
                <li class="divider"></li>
                <li role="menu-item">
                    <a href="#" onclick="showFindDialog(); return false;">Find...</a>
                </li>
            </ul>
        </li>
        <li role="menu-item" tabindex="0" aria-haspopup="true">
            View
            <ul role="menu">
                <li role="menu-item">
                    <a href="https://github.com/ben-gy/benrichardson.dev" target="_blank">View Source</a>
                </li>
                <li class="divider"></li>
                <li role="menu-item">
                    <a href="#" onclick="zoomIn(); return false;">Zoom In</a>
                </li>
                <li role="menu-item">
                    <a href="#" onclick="zoomOut(); return false;">Zoom Out</a>
                </li>
                <li class="divider"></li>
                <li role="menu-item">
                    <a href="#" onclick="location.reload(); return false;">Refresh</a>
                </li>
                <li class="divider"></li>
                <li role="menu-item">
                    <a href="#" onclick="cleanUp(); return false;">Clean Up</a>
                </li>
            </ul>
        </li>
        <li role="menu-item" tabindex="0" aria-haspopup="true">
            Sites
            <ul role="menu">
                <li role="menu-item">
                    <a href="https://github.com/ben-gy" target="_blank">GitHub</a>
                </li>
                <li role="menu-item">
                    <a href="https://www.linkedin.com/in/benrichardsonco/" target="_blank">LinkedIn</a>
                </li>
            </ul>
        </li>
        <li role="menu-item" tabindex="0" aria-haspopup="true">
            Apps
            <ul role="menu">
                <li role="menu-item">
                    <a href="#" onclick="toggleCalculator(); return false;">Calculator</a>
                </li>
                <li role="menu-item">
                    <a href="#" onclick="toggleNotePad(); return false;">Note Pad</a>
                </li>
                <li class="divider"></li>
                <li role="menu-item">
                    <a href="#" onclick="toggleEmail(); return false;">Email</a>
                </li>
                <li role="menu-item">
                    <a href="#" onclick="toggleSearch(); return false;">Internet</a>
                </li>
            </ul>
        </li>
        <li role="menu-item" tabindex="0" aria-haspopup="true">
            Game
            <ul role="menu">
                <li role="menu-item">
                    <a href="#" onclick="toggleLander(); return false;">Lunar Lander</a>
                </li>
                <li role="menu-item">
                    <a href="#" onclick="toggleStartrek(); return false;">Star Trek</a>
                </li>
                <li role="menu-item">
                    <a href="#" onclick="togglePuzzle(); return false;">Puzzle</a>
                </li>
                <li role="menu-item">
                    <a href="#" onclick="toggleBlackjack(); return false;">Blackjack</a>
                </li>
                <li role="menu-item">
                    <a href="#" onclick="toggleMastermind(); return false;">Mastermind</a>
                </li>
                <li role="menu-item">
                    <a href="#" onclick="toggleHamurabi(); return false;">Hamurabi</a>
                </li>
            </ul>
        </li>
        <li class="menu-clock" id="menu-clock" onclick="showDate()"></li>
    </ul>

    <!-- Main Window -->
    <div class="window" id="main-window" style="max-width: 640px; width: calc(100% - 2rem);">
        <div class="title-bar" id="title-bar">
            <button aria-label="Close" class="close" onclick="closeMainWindow()"></button>
            <h1 class="title">Ben Richardson</h1>
            <button aria-label="Resize" disabled class="hidden"></button>
        </div>
        <div class="separator"></div>
        <div class="window-pane">
            <p><strong>Indie hacker, aerospace engineer, full-stack founder</strong></p>
            <p>Based in Canberra/Melbourne, Australia</p>
            <p><a href="mailto:hi@benrichardson.dev">hi@benrichardson.dev</a></p>
            <section class="field-row" style="justify-content: flex-start; padding-top: 1rem;">
                <a href="https://github.com/ben-gy" target="_blank"><button class="btn">GitHub</button></a>
                <a href="https://www.linkedin.com/in/benrichardsonco/" target="_blank"><button class="btn">LinkedIn</button></a>
            </section>
        </div>
    </div>

    <!-- Calculator Window -->
    <div class="window calculator-window" id="calculator-window" style="display: none;">
        <div class="title-bar" id="calc-title-bar">
            <button aria-label="Close" class="close" onclick="toggleCalculator()"></button>
            <h1 class="title">Calculator</h1>
            <button aria-label="Resize" disabled class="hidden"></button>
        </div>
        <div class="separator"></div>
        <div class="window-pane">
            <div class="calc-display" id="calc-display">0</div>
            <div class="calc-buttons">
                <button class="btn" onclick="calcClear()">C</button>
                <button class="btn" onclick="calcInput('/')">/</button>
                <button class="btn" onclick="calcInput('*')">√ó</button>
                <button class="btn" onclick="calcBackspace()">‚å´</button>
                <button class="btn" onclick="calcInput('7')">7</button>
                <button class="btn" onclick="calcInput('8')">8</button>
                <button class="btn" onclick="calcInput('9')">9</button>
                <button class="btn" onclick="calcInput('-')">-</button>
                <button class="btn" onclick="calcInput('4')">4</button>
                <button class="btn" onclick="calcInput('5')">5</button>
                <button class="btn" onclick="calcInput('6')">6</button>
                <button class="btn" onclick="calcInput('+')">+</button>
                <button class="btn" onclick="calcInput('1')">1</button>
                <button class="btn" onclick="calcInput('2')">2</button>
                <button class="btn" onclick="calcInput('3')">3</button>
                <button class="btn btn-default" onclick="calcEquals()" style="grid-row: span 2;">=</button>
                <button class="btn" onclick="calcInput('0')" style="grid-column: span 2;">0</button>
                <button class="btn" onclick="calcInput('.')">.</button>
            </div>
        </div>
    </div>

    <!-- Puzzle Window -->
    <div class="window puzzle-window" id="puzzle-window" style="display: none;">
        <div class="title-bar" id="puzzle-title-bar">
            <button aria-label="Close" class="close" onclick="togglePuzzle()"></button>
            <h1 class="title">Puzzle</h1>
            <button aria-label="Resize" disabled class="hidden"></button>
        </div>
        <div class="separator"></div>
        <div class="window-pane">
            <div class="puzzle-grid" id="puzzle-grid"></div>
            <div class="puzzle-controls">
                <button class="btn" onclick="shufflePuzzle()">Shuffle</button>
            </div>
        </div>
    </div>

    <!-- Note Pad Window -->
    <div class="window notepad-window" id="notepad-window" style="display: none;">
        <div class="title-bar" id="notepad-title-bar">
            <button aria-label="Close" class="close" onclick="toggleNotePad()"></button>
            <h1 class="title">Note Pad</h1>
            <button aria-label="Resize" disabled class="hidden"></button>
        </div>
        <div class="separator"></div>
        <div class="window-pane">
            <div class="notepad-content">
                <textarea class="notepad-textarea" id="notepad-textarea" placeholder="Type your notes here..."></textarea>
                <div class="notepad-corner" onclick="nextNotePage()">üìÑ</div>
            </div>
            <div class="notepad-page-num">Page <span id="notepad-page-num">1</span> of <span id="notepad-total-pages">8</span></div>
        </div>
    </div>

    <!-- Email Window -->
    <div class="window email-window" id="email-window" style="display: none;">
        <div class="title-bar" id="email-title-bar">
            <button aria-label="Close" class="close" onclick="toggleEmail()"></button>
            <h1 class="title">Email</h1>
            <button aria-label="Resize" disabled class="hidden"></button>
        </div>
        <div class="separator"></div>
        <div class="window-pane">
            <section class="field-row" style="justify-content: flex-start">
                <label class="modeless-text" style="width: 60px;">To:</label>
                <input type="text" value="hi@benrichardson.dev" readonly onclick="copyEmailAddress()" style="flex: 1;" title="Click to copy">
            </section>
            <section class="field-row" style="justify-content: flex-start">
                <label class="modeless-text" style="width: 60px;">Subject:</label>
                <input type="text" id="email-subject" style="flex: 1;" placeholder="">
            </section>
            <label class="modeless-text">Message:</label>
            <textarea id="email-body" placeholder=""></textarea>
            <section class="field-row" style="justify-content: flex-end; margin-top: 0.5rem;">
                <button class="btn" onclick="toggleEmail()">Cancel</button>
                <button class="btn btn-default" onclick="sendEmail()">Send</button>
            </section>
        </div>
    </div>

    <!-- Internet Search Window -->
    <div class="window search-window" id="search-window" style="display: none; width: 300px;">
        <div class="title-bar" id="search-title-bar">
            <button aria-label="Close" class="close" onclick="toggleSearch()"></button>
            <h1 class="title">Internet Search</h1>
            <button aria-label="Resize" disabled class="hidden"></button>
        </div>
        <div class="separator"></div>
        <div class="window-pane">
            <section class="field-row" style="justify-content: flex-start">
                <label for="search-input" class="modeless-text">Search:</label>
                <input id="search-input" type="text" style="flex: 1;" placeholder="Search the web...">
            </section>
            <section class="field-row" style="justify-content: flex-end; margin-top: 0.5rem;">
                <button class="btn" onclick="toggleSearch()">Cancel</button>
                <button class="btn btn-default" onclick="searchGoogle()">Search</button>
            </section>
        </div>
    </div>

    <!-- Lunar Lander Window -->
    <div class="window" id="lander-window" style="display: none; width: 280px;">
        <div class="title-bar" id="lander-title-bar">
            <button aria-label="Close" class="close" onclick="toggleLander()"></button>
            <h1 class="title">Lunar Lander</h1>
            <button aria-label="Resize" disabled class="hidden"></button>
        </div>
        <div class="separator"></div>
        <div class="window-pane">
            <pre class="lander-output" id="lander-output"></pre>
            <section class="field-row" style="justify-content: flex-start">
                <label class="modeless-text">BURN:</label>
                <input type="number" id="lander-input" min="0" max="30" style="width: 60px;">
                <button class="btn btn-default" onclick="landerBurn()">OK</button>
            </section>
        </div>
    </div>

    <!-- Star Trek Window -->
    <div class="window startrek-window" id="startrek-window" style="display: none;">
        <div class="title-bar" id="startrek-title-bar">
            <button aria-label="Close" class="close" onclick="toggleStartrek()"></button>
            <h1 class="title">Star Trek</h1>
            <button aria-label="Resize" disabled class="hidden"></button>
        </div>
        <div class="separator"></div>
        <div class="window-pane">
            <pre class="startrek-output" id="startrek-output"></pre>
            <section class="field-row" style="justify-content: flex-start">
                <label class="modeless-text">CMD:</label>
                <input type="text" id="startrek-input" style="flex: 1; text-transform: uppercase;" placeholder="NAV, SRS, LRS, PHA, TOR, SHE">
                <button class="btn btn-default" onclick="trekCommand()">OK</button>
            </section>
        </div>
    </div>

    <!-- Blackjack Window -->
    <div class="window blackjack-window" id="blackjack-window" style="display: none;">
        <div class="title-bar" id="blackjack-title-bar">
            <button aria-label="Close" class="close" onclick="toggleBlackjack()"></button>
            <h1 class="title">Blackjack</h1>
            <button aria-label="Resize" disabled class="hidden"></button>
        </div>
        <div class="separator"></div>
        <div class="window-pane">
            <pre class="blackjack-output" id="blackjack-output"></pre>
            <div class="blackjack-buttons">
                <button class="btn" onclick="bjHit()">Hit</button>
                <button class="btn" onclick="bjStand()">Stand</button>
                <button class="btn btn-default" onclick="bjNewGame()">Deal</button>
            </div>
        </div>
    </div>

    <!-- Mastermind Window -->
    <div class="window mastermind-window" id="mastermind-window" style="display: none;">
        <div class="title-bar" id="mastermind-title-bar">
            <button aria-label="Close" class="close" onclick="toggleMastermind()"></button>
            <h1 class="title">Mastermind</h1>
            <button aria-label="Resize" disabled class="hidden"></button>
        </div>
        <div class="separator"></div>
        <div class="window-pane">
            <pre class="mastermind-output" id="mastermind-output"></pre>
            <section class="field-row" style="justify-content: flex-start">
                <label class="modeless-text">GUESS:</label>
                <input type="text" id="mastermind-input" maxlength="5" style="width: 80px; text-align: center;" placeholder="00000">
                <button class="btn btn-default" onclick="mmGuess()">OK</button>
            </section>
        </div>
    </div>

    <!-- Hamurabi Window -->
    <div class="window hamurabi-window" id="hamurabi-window" style="display: none;">
        <div class="title-bar" id="hamurabi-title-bar">
            <button aria-label="Close" class="close" onclick="toggleHamurabi()"></button>
            <h1 class="title">Hamurabi</h1>
            <button aria-label="Resize" disabled class="hidden"></button>
        </div>
        <div class="separator"></div>
        <div class="window-pane">
            <pre class="hamurabi-output" id="hamurabi-output"></pre>
            <section class="field-row" style="justify-content: flex-start">
                <label class="modeless-text" id="hamurabi-label">ACRES:</label>
                <input type="number" id="hamurabi-input" style="width: 80px; text-align: center;">
                <button class="btn btn-default" onclick="hamSubmit()">OK</button>
            </section>
        </div>
    </div>

    <!-- About This Mac Modal -->
    <div class="modal-overlay" id="about-mac-modal">
        <div class="modal-dialog outer-border">
            <div class="inner-border">
                <div class="modal-contents">
                    <img src="icon/apple.svg" alt="Apple" style="width: 48px; height: 48px; margin-bottom: 1rem;">
                    <h2 style="margin: 0;">Ben Richardson OS</h2>
                    <p>Version 1.0</p>
                    <div class="credits-container">
                        <div class="credits-scroll">
                            <p style="font-size: 0.8rem;">Created by Ben Richardson</p>
                            <p style="font-size: 0.8rem;">&nbsp;</p>
                            <p style="font-size: 0.8rem; font-weight: bold;">--- UI Framework ---</p>
                            <p style="font-size: 0.8rem;"><a href="https://github.com/sakofchit/system.css" target="_blank">system.css</a> by @sakofchit</p>
                            <p style="font-size: 0.8rem;">Icons by Susan Kare (1984)</p>
                            <p style="font-size: 0.8rem;">&nbsp;</p>
                            <p style="font-size: 0.8rem; font-weight: bold;">--- Classic Games ---</p>
                            <p style="font-size: 0.8rem;">Lunar Lander by Jim Storer (1969)</p>
                            <p style="font-size: 0.8rem;">Star Trek by Mike Mayfield (1971)</p>
                            <p style="font-size: 0.8rem;">Hamurabi by Doug Dyment (1968)</p>
                            <p style="font-size: 0.8rem;">Mastermind by Steve Wozniak (1976)</p>
                            <p style="font-size: 0.8rem;">15-Puzzle by Sam Loyd (1878)</p>
                            <p style="font-size: 0.8rem;">&nbsp;</p>
                            <p style="font-size: 0.8rem; font-weight: bold;">--- Publications ---</p>
                            <p style="font-size: 0.8rem;">"BASIC Computer Games" (1978)</p>
                            <p style="font-size: 0.8rem;">by David Ahl</p>
                            <p style="font-size: 0.8rem;">&nbsp;</p>
                            <p style="font-size: 0.8rem;">Inspired by Apple Macintosh</p>
                            <p style="font-size: 0.8rem;">and the Apple 1 (1976)</p>
                            <p style="font-size: 0.8rem;">&nbsp;</p>
                            <p style="font-size: 0.8rem;">¬© 2024 Ben Richardson</p>
                        </div>
                    </div>
                    <button class="btn btn-default" onclick="hideModal('about-mac-modal')" style="margin-top: 1rem;">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Find Dialog -->
    <div class="modal-overlay" id="find-modal">
        <div class="window" style="width: 300px;">
            <div class="title-bar">
                <button aria-label="Close" class="close" onclick="hideModal('find-modal')"></button>
                <h1 class="title">Find</h1>
                <button aria-label="Resize" disabled class="hidden"></button>
            </div>
            <div class="separator"></div>
            <div class="modeless-dialog">
                <section class="field-row" style="justify-content: flex-start">
                    <label for="find-input" class="modeless-text">Find:</label>
                    <input id="find-input" type="text" style="width: 100%;" placeholder="">
                </section>
                <section class="field-row" style="justify-content: flex-end; margin-top: 1rem;">
                    <button class="btn" onclick="hideModal('find-modal')">Cancel</button>
                    <button class="btn btn-default" onclick="doFind()">Find</button>
                </section>
            </div>
        </div>
    </div>

    <!-- Alert Box Modal -->
    <div class="modal-overlay" id="alert-modal">
        <div class="alert-box outer-border">
            <div class="inner-border">
                <div class="alert-contents">
                    <p class="alert-text" id="alert-text">Alert message</p>
                    <div class="alert-buttons">
                        <button class="btn btn-default" onclick="hideModal('alert-modal')">OK</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bomb Error Modal -->
    <div class="modal-overlay" id="bomb-modal">
        <div class="alert-box outer-border">
            <div class="inner-border">
                <div class="alert-contents">
                    <span class="alert-icon">üí£</span>
                    <div class="alert-text-container">
                        <p class="alert-text">Sorry, a system error occurred.</p>
                        <p style="font-size: 0.8rem; margin: 0.5rem 0;">"Ben Richardson"</p>
                        <p style="font-size: 0.7rem; margin: 0;">unimplemented trap</p>
                        <div class="alert-buttons">
                            <button class="btn" onclick="restartSystem()">Restart</button>
                            <button class="btn btn-default" onclick="hideModal('bomb-modal')">Resume</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Konami Code Success Modal -->
    <div class="modal-overlay" id="konami-modal">
        <div class="modal-dialog outer-border">
            <div class="inner-border">
                <div class="modal-contents">
                    <p style="font-size: 2rem; margin: 0;">üéâ</p>
                    <h2 style="margin: 0.5rem 0;">Secret Unlocked!</h2>
                    <p>You found the Konami Code easter egg!</p>
                    <p style="font-size: 0.8rem;">‚Üë‚Üë‚Üì‚Üì‚Üê‚Üí‚Üê‚ÜíBA</p>
                    <button class="btn btn-default" onclick="hideModal('konami-modal')" style="margin-top: 1rem;">Nice!</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Puzzle Win Modal -->
    <div class="modal-overlay" id="puzzle-win-modal">
        <div class="modal-dialog outer-border">
            <div class="inner-border">
                <div class="modal-contents">
                    <p style="font-size: 2rem; margin: 0;">üéä</p>
                    <h2 style="margin: 0.5rem 0;">You Win!</h2>
                    <p>Congratulations, you solved the puzzle!</p>
                    <button class="btn btn-default" onclick="hideModal('puzzle-win-modal')" style="margin-top: 1rem;">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ EMAIL ============
        function toggleEmail() {
            const email = document.getElementById('email-window');
            if (email.style.display === 'none') {
                email.style.display = 'block';
                email.style.left = '80px';
                email.style.top = '90px';
                document.getElementById('email-subject').value = '';
                document.getElementById('email-body').value = '';
                document.getElementById('email-subject').focus();
            } else {
                email.style.display = 'none';
            }
        }

        function copyEmailAddress() {
            navigator.clipboard.writeText('hi@benrichardson.dev');
            showAlert('Email copied to clipboard!');
        }

        function sendEmail() {
            const subject = encodeURIComponent(document.getElementById('email-subject').value);
            const body = encodeURIComponent(document.getElementById('email-body').value);
            window.location.href = 'mailto:hi@benrichardson.dev?subject=' + subject + '&body=' + body;
            toggleEmail();
        }

        // ============ INTERNET SEARCH ============
        function toggleSearch() {
            const search = document.getElementById('search-window');
            if (search.style.display === 'none') {
                search.style.display = 'block';
                search.style.left = '100px';
                search.style.top = '130px';
                document.getElementById('search-input').value = '';
                document.getElementById('search-input').focus();
            } else {
                search.style.display = 'none';
            }
        }

        function searchGoogle() {
            const query = document.getElementById('search-input').value;
            if (query.trim()) {
                window.open('https://www.google.com/search?q=' + encodeURIComponent(query), '_blank');
                toggleSearch();
            }
        }

        // ============ LUNAR LANDER GAME ============
        let landerState = null;

        function initLander() {
            landerState = {
                altitude: 120,
                velocity: 1,
                fuel: 1600,
                gameOver: false,
                message: ''
            };
        }

        function toggleLander() {
            const lander = document.getElementById('lander-window');
            if (lander.style.display === 'none') {
                lander.style.display = 'block';
                lander.style.left = '120px';
                lander.style.top = '80px';
                initLander();
                updateLanderDisplay();
                document.getElementById('lander-input').value = '';
                document.getElementById('lander-input').focus();
            } else {
                lander.style.display = 'none';
            }
        }

        function updateLanderDisplay() {
            const output = document.getElementById('lander-output');
            let text = 'LUNAR LANDER\n';
            text += '====================\n\n';
            text += 'ALTITUDE: ' + landerState.altitude.toFixed(1) + ' MI\n';
            text += 'VELOCITY: ' + landerState.velocity.toFixed(1) + ' MI/S\n';
            text += 'FUEL:     ' + landerState.fuel.toFixed(0) + '\n\n';

            if (landerState.message) {
                text += landerState.message + '\n';
            }

            if (!landerState.gameOver) {
                text += 'BURN RATE? (0-30)';
            } else {
                text += '\n[OK TO PLAY AGAIN]';
            }

            output.textContent = text;
        }

        function landerBurn() {
            if (landerState.gameOver) {
                initLander();
                updateLanderDisplay();
                document.getElementById('lander-input').value = '';
                return;
            }

            let burn = parseInt(document.getElementById('lander-input').value) || 0;
            burn = Math.max(0, Math.min(30, burn));

            if (burn > landerState.fuel) {
                burn = landerState.fuel;
            }

            const thrustAcc = (burn * 1.8) / 33000;
            const netAcc = 0.001 - thrustAcc;
            landerState.velocity += netAcc * 10;
            landerState.altitude -= landerState.velocity * 10;
            landerState.fuel -= burn;

            if (landerState.altitude <= 0) {
                landerState.altitude = 0;
                if (landerState.velocity < 2) {
                    landerState.message = '*** SAFE LANDING! ***\nFUEL LEFT: ' + landerState.fuel.toFixed(0);
                } else {
                    landerState.message = '*** CRASH! ***\nTOO FAST: ' + landerState.velocity.toFixed(1);
                }
                landerState.gameOver = true;
            } else if (landerState.fuel <= 0) {
                landerState.message = 'OUT OF FUEL!';
            } else {
                landerState.message = '';
            }

            updateLanderDisplay();
            document.getElementById('lander-input').value = '';
            document.getElementById('lander-input').focus();
        }

        // Allow Enter key to submit in Email
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('email-subject').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('email-body').focus();
                }
            });
        });

        // ============ STAR TREK GAME ============
        let trek = null;

        function initTrek() {
            trek = {
                quadrant: { x: Math.floor(Math.random() * 8), y: Math.floor(Math.random() * 8) },
                sector: { x: Math.floor(Math.random() * 8), y: Math.floor(Math.random() * 8) },
                energy: 3000,
                shields: 0,
                torpedoes: 10,
                stardate: 0,
                maxStardate: 30,
                klingonsTotal: 0,
                basesTotal: 0,
                galaxy: [],
                sector_map: [],
                klingons: [],
                docked: false,
                gameOver: false,
                message: ''
            };

            // Initialize galaxy - 8x8 quadrants
            for (let i = 0; i < 8; i++) {
                trek.galaxy[i] = [];
                for (let j = 0; j < 8; j++) {
                    const k = Math.random() < 0.15 ? (Math.random() < 0.3 ? 2 : 1) : 0;
                    const b = Math.random() < 0.08 ? 1 : 0;
                    const s = Math.floor(Math.random() * 8) + 1;
                    trek.galaxy[i][j] = { klingons: k, bases: b, stars: s, scanned: false };
                    trek.klingonsTotal += k;
                    trek.basesTotal += b;
                }
            }

            // Ensure at least some klingons and one base
            if (trek.klingonsTotal < 5) {
                trek.galaxy[0][0].klingons = 3;
                trek.klingonsTotal += 3;
            }
            if (trek.basesTotal < 1) {
                trek.galaxy[4][4].bases = 1;
                trek.basesTotal = 1;
            }

            trek.maxStardate = 25 + Math.floor(trek.klingonsTotal * 1.5);
            enterQuadrant();
        }

        function enterQuadrant() {
            const q = trek.galaxy[trek.quadrant.x][trek.quadrant.y];
            q.scanned = true;
            trek.klingons = [];
            trek.sector_map = [];

            // Initialize empty sector map
            for (let i = 0; i < 8; i++) {
                trek.sector_map[i] = [];
                for (let j = 0; j < 8; j++) {
                    trek.sector_map[i][j] = '.';
                }
            }

            // Place Enterprise
            trek.sector_map[trek.sector.x][trek.sector.y] = 'E';

            // Place Klingons
            for (let i = 0; i < q.klingons; i++) {
                let x, y;
                do {
                    x = Math.floor(Math.random() * 8);
                    y = Math.floor(Math.random() * 8);
                } while (trek.sector_map[x][y] !== '.');
                trek.sector_map[x][y] = 'K';
                trek.klingons.push({ x: x, y: y, energy: 200 + Math.floor(Math.random() * 200) });
            }

            // Place bases
            for (let i = 0; i < q.bases; i++) {
                let x, y;
                do {
                    x = Math.floor(Math.random() * 8);
                    y = Math.floor(Math.random() * 8);
                } while (trek.sector_map[x][y] !== '.');
                trek.sector_map[x][y] = 'B';
            }

            // Place stars
            for (let i = 0; i < q.stars; i++) {
                let x, y;
                do {
                    x = Math.floor(Math.random() * 8);
                    y = Math.floor(Math.random() * 8);
                } while (trek.sector_map[x][y] !== '.');
                trek.sector_map[x][y] = '*';
            }

            checkDocked();
        }

        function checkDocked() {
            const dirs = [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];
            trek.docked = false;
            for (const d of dirs) {
                const nx = trek.sector.x + d[0];
                const ny = trek.sector.y + d[1];
                if (nx >= 0 && nx < 8 && ny >= 0 && ny < 8 && trek.sector_map[nx][ny] === 'B') {
                    trek.docked = true;
                    trek.energy = 3000;
                    trek.torpedoes = 10;
                    break;
                }
            }
        }

        function getCondition() {
            if (trek.docked) return 'DOCKED';
            if (trek.klingons.length > 0) return '*RED*';
            if (trek.energy < 300) return 'YELLOW';
            return 'GREEN';
        }

        function toggleStartrek() {
            const win = document.getElementById('startrek-window');
            if (win.style.display === 'none') {
                win.style.display = 'block';
                win.style.left = '60px';
                win.style.top = '60px';
                initTrek();
                trekOutput(getWelcome() + '\n\n' + shortRangeScan());
                document.getElementById('startrek-input').value = '';
                document.getElementById('startrek-input').focus();
            } else {
                win.style.display = 'none';
            }
        }

        function getWelcome() {
            return 'STAR TREK\n' +
                '========================\n' +
                'DESTROY ' + trek.klingonsTotal + ' KLINGONS IN ' + trek.maxStardate + ' STARDATES\n' +
                'YOU HAVE ' + trek.basesTotal + ' STARBASE(S)\n\n' +
                'COMMANDS: NAV SRS LRS PHA TOR SHE';
        }

        function shortRangeScan() {
            let out = '    0 1 2 3 4 5 6 7\n';
            out += '   +-+-+-+-+-+-+-+-+\n';
            for (let i = 0; i < 8; i++) {
                out += ' ' + i + ' |';
                for (let j = 0; j < 8; j++) {
                    const c = trek.sector_map[i][j];
                    out += c + '|';
                }
                out += '\n';
            }
            out += '   +-+-+-+-+-+-+-+-+\n';
            out += 'QUADRANT: ' + (trek.quadrant.x + 1) + ',' + (trek.quadrant.y + 1);
            out += '  SECTOR: ' + (trek.sector.x + 1) + ',' + (trek.sector.y + 1) + '\n';
            out += 'STARDATE: ' + trek.stardate + '/' + trek.maxStardate;
            out += '  COND: ' + getCondition() + '\n';
            out += 'ENERGY: ' + trek.energy + '  SHIELDS: ' + trek.shields + '\n';
            out += 'TORPEDOES: ' + trek.torpedoes + '  KLINGONS: ' + trek.klingonsTotal;
            return out;
        }

        function longRangeScan() {
            let out = 'LONG RANGE SCAN\n';
            out += '    ' + (trek.quadrant.y) + '   ' + (trek.quadrant.y + 1) + '   ' + (trek.quadrant.y + 2) + '\n';
            out += '  +---+---+---+\n';
            for (let dx = -1; dx <= 1; dx++) {
                const qx = trek.quadrant.x + dx;
                out += (trek.quadrant.x + dx + 1) + ' |';
                for (let dy = -1; dy <= 1; dy++) {
                    const qy = trek.quadrant.y + dy;
                    if (qx >= 0 && qx < 8 && qy >= 0 && qy < 8) {
                        const q = trek.galaxy[qx][qy];
                        q.scanned = true;
                        out += '' + q.klingons + q.bases + q.stars + '|';
                    } else {
                        out += '***|';
                    }
                }
                out += '\n';
            }
            out += '  +---+---+---+';
            return out;
        }

        function navigate(course, warp) {
            if (warp <= 0 || warp > 8) {
                return 'WARP FACTOR MUST BE 1-8';
            }
            const energy_needed = Math.floor(warp * 100);
            if (energy_needed > trek.energy) {
                return 'INSUFFICIENT ENERGY FOR WARP ' + warp;
            }

            // Direction vectors (1-9, 1=right, going counter-clockwise)
            const dx = [0, 0, -1, -1, -1, 0, 1, 1, 1];
            const dy = [0, 1, 1, 0, -1, -1, -1, 0, 1];
            const dir = Math.round(course);
            if (dir < 1 || dir > 8) {
                return 'COURSE MUST BE 1-8';
            }

            const sectors_to_move = Math.floor(warp * 8);
            let sx = trek.sector.x;
            let sy = trek.sector.y;
            let qx = trek.quadrant.x;
            let qy = trek.quadrant.y;

            // Clear old position
            trek.sector_map[trek.sector.x][trek.sector.y] = '.';

            for (let i = 0; i < sectors_to_move; i++) {
                const nx = sx + dx[dir];
                const ny = sy + dy[dir];

                if (nx < 0 || nx >= 8 || ny < 0 || ny >= 8) {
                    // Crossing quadrant boundary
                    qx += dx[dir];
                    qy += dy[dir];
                    if (qx < 0 || qx >= 8 || qy < 0 || qy >= 8) {
                        qx = Math.max(0, Math.min(7, qx));
                        qy = Math.max(0, Math.min(7, qy));
                        break;
                    }
                    sx = (nx + 8) % 8;
                    sy = (ny + 8) % 8;
                    trek.quadrant.x = qx;
                    trek.quadrant.y = qy;
                    trek.sector.x = sx;
                    trek.sector.y = sy;
                    trek.stardate++;
                    trek.energy -= energy_needed;
                    enterQuadrant();
                    let msg = 'ENTERING QUADRANT ' + (qx + 1) + ',' + (qy + 1);
                    if (trek.klingons.length > 0) {
                        msg += '\nCOMBAT AREA - ' + trek.klingons.length + ' KLINGON(S) DETECTED';
                        msg += '\n' + klingonAttack();
                    }
                    return msg + '\n\n' + shortRangeScan();
                }

                // Check collision within quadrant
                if (trek.sector_map[nx][ny] !== '.') {
                    break;
                }
                sx = nx;
                sy = ny;
            }

            trek.sector.x = sx;
            trek.sector.y = sy;
            trek.sector_map[sx][sy] = 'E';
            trek.energy -= energy_needed;
            checkDocked();

            let msg = '';
            if (trek.docked) {
                msg = 'DOCKED AT STARBASE - ENERGY AND TORPEDOES REPLENISHED\n\n';
            }
            if (trek.klingons.length > 0 && !trek.docked) {
                msg += klingonAttack() + '\n\n';
            }
            return msg + shortRangeScan();
        }

        function firePhasers(energy) {
            if (energy <= 0) return 'PHASER ENERGY MUST BE > 0';
            if (energy > trek.energy) return 'INSUFFICIENT ENERGY';
            if (trek.klingons.length === 0) return 'NO KLINGONS IN THIS QUADRANT';

            trek.energy -= energy;
            const energy_per_klingon = energy / trek.klingons.length;
            let msg = 'PHASERS FIRE!\n';

            for (let i = trek.klingons.length - 1; i >= 0; i--) {
                const k = trek.klingons[i];
                const dist = Math.sqrt(Math.pow(trek.sector.x - k.x, 2) + Math.pow(trek.sector.y - k.y, 2));
                const damage = Math.floor(energy_per_klingon / (dist + 1) * (0.5 + Math.random() * 0.5));
                k.energy -= damage;
                msg += damage + ' DAMAGE TO KLINGON AT ' + (k.x + 1) + ',' + (k.y + 1);
                if (k.energy <= 0) {
                    msg += ' - DESTROYED!';
                    trek.sector_map[k.x][k.y] = '.';
                    trek.klingons.splice(i, 1);
                    trek.klingonsTotal--;
                    trek.galaxy[trek.quadrant.x][trek.quadrant.y].klingons--;
                }
                msg += '\n';
            }

            if (trek.klingonsTotal === 0) {
                trek.gameOver = true;
                msg += '\n*** CONGRATULATIONS! ALL KLINGONS DESTROYED! ***';
                return msg;
            }

            if (trek.klingons.length > 0) {
                msg += '\n' + klingonAttack();
            }
            return msg;
        }

        function fireTorpedo(course) {
            if (trek.torpedoes <= 0) return 'NO TORPEDOES LEFT';
            const dir = Math.round(course);
            if (dir < 1 || dir > 8) return 'COURSE MUST BE 1-8';

            trek.torpedoes--;
            const dx = [0, 0, -1, -1, -1, 0, 1, 1, 1];
            const dy = [0, 1, 1, 0, -1, -1, -1, 0, 1];

            let tx = trek.sector.x;
            let ty = trek.sector.y;
            let msg = 'TORPEDO TRACK: ';

            for (let i = 0; i < 8; i++) {
                tx += dx[dir];
                ty += dy[dir];
                if (tx < 0 || tx >= 8 || ty < 0 || ty >= 8) {
                    msg += 'MISSED - LEFT QUADRANT';
                    break;
                }
                msg += '(' + (tx + 1) + ',' + (ty + 1) + ') ';
                const target = trek.sector_map[tx][ty];
                if (target === 'K') {
                    msg += '\n*** KLINGON DESTROYED! ***';
                    trek.sector_map[tx][ty] = '.';
                    for (let j = 0; j < trek.klingons.length; j++) {
                        if (trek.klingons[j].x === tx && trek.klingons[j].y === ty) {
                            trek.klingons.splice(j, 1);
                            break;
                        }
                    }
                    trek.klingonsTotal--;
                    trek.galaxy[trek.quadrant.x][trek.quadrant.y].klingons--;
                    if (trek.klingonsTotal === 0) {
                        trek.gameOver = true;
                        msg += '\n*** CONGRATULATIONS! ALL KLINGONS DESTROYED! ***';
                    }
                    break;
                } else if (target === '*') {
                    msg += '\nTORPEDO HIT STAR - ABSORBED';
                    break;
                } else if (target === 'B') {
                    msg += '\n*** STARBASE DESTROYED! ***';
                    trek.sector_map[tx][ty] = '.';
                    trek.basesTotal--;
                    trek.galaxy[trek.quadrant.x][trek.quadrant.y].bases--;
                    break;
                }
            }

            if (trek.klingons.length > 0 && !trek.gameOver) {
                msg += '\n\n' + klingonAttack();
            }
            return msg;
        }

        function adjustShields(amount) {
            const total = trek.energy + trek.shields;
            if (amount < 0 || amount > total) {
                return 'INVALID SHIELD AMOUNT (0-' + total + ')';
            }
            trek.shields = amount;
            trek.energy = total - amount;
            return 'SHIELDS SET TO ' + trek.shields + ', ENERGY: ' + trek.energy;
        }

        function klingonAttack() {
            if (trek.klingons.length === 0 || trek.docked) return '';
            let msg = 'KLINGON ATTACK!\n';
            let total_damage = 0;

            for (const k of trek.klingons) {
                const dist = Math.sqrt(Math.pow(trek.sector.x - k.x, 2) + Math.pow(trek.sector.y - k.y, 2));
                const damage = Math.floor((k.energy / (dist + 1)) * (0.3 + Math.random() * 0.4));
                total_damage += damage;
                msg += damage + ' DAMAGE FROM KLINGON AT ' + (k.x + 1) + ',' + (k.y + 1) + '\n';
            }

            if (trek.shields >= total_damage) {
                trek.shields -= total_damage;
                msg += 'SHIELDS ABSORB HIT. SHIELDS: ' + trek.shields;
            } else {
                total_damage -= trek.shields;
                trek.shields = 0;
                trek.energy -= total_damage;
                msg += 'DAMAGE! ENERGY: ' + trek.energy + ' SHIELDS: 0';
                if (trek.energy <= 0) {
                    trek.gameOver = true;
                    msg += '\n*** ENTERPRISE DESTROYED! ***';
                }
            }
            return msg;
        }

        function trekOutput(text) {
            const output = document.getElementById('startrek-output');
            output.textContent = text;
            output.scrollTop = output.scrollHeight;
        }

        function trekCommand() {
            if (trek.gameOver) {
                initTrek();
                trekOutput(getWelcome() + '\n\n' + shortRangeScan());
                document.getElementById('startrek-input').value = '';
                return;
            }

            const input = document.getElementById('startrek-input').value.toUpperCase().trim();
            document.getElementById('startrek-input').value = '';
            const parts = input.split(/\s+/);
            const cmd = parts[0];
            let result = '';

            if (trek.stardate >= trek.maxStardate) {
                trek.gameOver = true;
                trekOutput('*** TIME EXPIRED! KLINGONS CONQUER FEDERATION! ***');
                return;
            }

            switch (cmd) {
                case 'NAV':
                    if (parts.length < 3) {
                        result = 'NAV <course 1-8> <warp 1-8>\nCOURSE: 1=E 2=NE 3=N 4=NW 5=W 6=SW 7=S 8=SE';
                    } else {
                        result = navigate(parseFloat(parts[1]), parseFloat(parts[2]));
                    }
                    break;
                case 'SRS':
                    result = shortRangeScan();
                    break;
                case 'LRS':
                    result = longRangeScan();
                    break;
                case 'PHA':
                    if (parts.length < 2) {
                        result = 'PHA <energy>\nENERGY AVAILABLE: ' + trek.energy;
                    } else {
                        result = firePhasers(parseInt(parts[1]));
                    }
                    break;
                case 'TOR':
                    if (parts.length < 2) {
                        result = 'TOR <course 1-8>\nCOURSE: 1=E 2=NE 3=N 4=NW 5=W 6=SW 7=S 8=SE';
                    } else {
                        result = fireTorpedo(parseFloat(parts[1]));
                    }
                    break;
                case 'SHE':
                    if (parts.length < 2) {
                        result = 'SHE <amount>\nCURRENT: ' + trek.shields + ' MAX: ' + (trek.energy + trek.shields);
                    } else {
                        result = adjustShields(parseInt(parts[1]));
                    }
                    break;
                default:
                    result = 'COMMANDS:\nNAV <course> <warp> - Navigate\nSRS - Short Range Scan\nLRS - Long Range Scan\nPHA <energy> - Fire Phasers\nTOR <course> - Fire Torpedo\nSHE <amount> - Set Shields';
            }

            trekOutput(result);
        }

        // Enter key support for Star Trek
        document.getElementById('startrek-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                trekCommand();
            }
        });

        // ============ BLACKJACK GAME ============
        let bj = null;

        function initBlackjack() {
            bj = {
                deck: [],
                playerHand: [],
                dealerHand: [],
                gameOver: false,
                playerStood: false,
                wins: 0,
                losses: 0,
                pushes: 0
            };
            createDeck();
            shuffleDeck();
        }

        function createDeck() {
            bj.deck = [];
            const suits = ['‚ô†', '‚ô•', '‚ô¶', '‚ô£'];
            const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            for (const suit of suits) {
                for (const value of values) {
                    bj.deck.push({ value: value, suit: suit });
                }
            }
        }

        function shuffleDeck() {
            for (let i = bj.deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [bj.deck[i], bj.deck[j]] = [bj.deck[j], bj.deck[i]];
            }
        }

        function dealCard(hand) {
            if (bj.deck.length === 0) {
                createDeck();
                shuffleDeck();
            }
            hand.push(bj.deck.pop());
        }

        function getCardValue(card) {
            if (card.value === 'A') return 11;
            if (['K', 'Q', 'J'].includes(card.value)) return 10;
            return parseInt(card.value);
        }

        function calculateScore(hand) {
            let score = 0;
            let aces = 0;
            for (const card of hand) {
                score += getCardValue(card);
                if (card.value === 'A') aces++;
            }
            while (score > 21 && aces > 0) {
                score -= 10;
                aces--;
            }
            return score;
        }

        function formatCard(card) {
            return card.value + card.suit;
        }

        function formatHand(hand, hideFirst) {
            if (hideFirst && hand.length > 0) {
                return '[?] ' + hand.slice(1).map(formatCard).join(' ');
            }
            return hand.map(formatCard).join(' ');
        }

        function bjNewGame() {
            if (!bj) initBlackjack();
            bj.playerHand = [];
            bj.dealerHand = [];
            bj.gameOver = false;
            bj.playerStood = false;

            if (bj.deck.length < 10) {
                createDeck();
                shuffleDeck();
            }

            dealCard(bj.playerHand);
            dealCard(bj.dealerHand);
            dealCard(bj.playerHand);
            dealCard(bj.dealerHand);

            // Check for blackjack
            const playerScore = calculateScore(bj.playerHand);
            const dealerScore = calculateScore(bj.dealerHand);

            if (playerScore === 21 && dealerScore === 21) {
                bj.gameOver = true;
                bj.pushes++;
                bjUpdateDisplay('PUSH! Both have Blackjack!');
            } else if (playerScore === 21) {
                bj.gameOver = true;
                bj.wins++;
                bjUpdateDisplay('BLACKJACK! You win!');
            } else if (dealerScore === 21) {
                bj.gameOver = true;
                bj.losses++;
                bjUpdateDisplay('Dealer has Blackjack!');
            } else {
                bjUpdateDisplay('');
            }
        }

        function bjHit() {
            if (!bj || bj.gameOver) return;
            dealCard(bj.playerHand);
            const score = calculateScore(bj.playerHand);
            if (score > 21) {
                bj.gameOver = true;
                bj.losses++;
                bjUpdateDisplay('BUST! You lose.');
            } else if (score === 21) {
                bjStand();
            } else {
                bjUpdateDisplay('');
            }
        }

        function bjStand() {
            if (!bj || bj.gameOver) return;
            bj.playerStood = true;

            // Dealer plays
            while (calculateScore(bj.dealerHand) < 17) {
                dealCard(bj.dealerHand);
            }

            const playerScore = calculateScore(bj.playerHand);
            const dealerScore = calculateScore(bj.dealerHand);
            bj.gameOver = true;

            let msg = '';
            if (dealerScore > 21) {
                bj.wins++;
                msg = 'Dealer busts! You win!';
            } else if (playerScore > dealerScore) {
                bj.wins++;
                msg = 'You win!';
            } else if (dealerScore > playerScore) {
                bj.losses++;
                msg = 'Dealer wins.';
            } else {
                bj.pushes++;
                msg = 'Push!';
            }
            bjUpdateDisplay(msg);
        }

        function bjUpdateDisplay(message) {
            let out = '      BLACKJACK\n';
            out += '  ==================\n\n';
            out += '  DEALER: ' + formatHand(bj.dealerHand, !bj.gameOver && !bj.playerStood) + '\n';
            if (bj.gameOver || bj.playerStood) {
                out += '          (' + calculateScore(bj.dealerHand) + ')\n';
            }
            out += '\n';
            out += '  YOU:    ' + formatHand(bj.playerHand, false) + '\n';
            out += '          (' + calculateScore(bj.playerHand) + ')\n\n';
            if (message) {
                out += '  ' + message + '\n\n';
            }
            if (!bj.gameOver) {
                out += '  [Hit] or [Stand]?\n';
            } else {
                out += '  [Deal] for new game\n';
            }
            out += '\n  W:' + bj.wins + ' L:' + bj.losses + ' P:' + bj.pushes;
            document.getElementById('blackjack-output').textContent = out;
        }

        function toggleBlackjack() {
            const win = document.getElementById('blackjack-window');
            if (win.style.display === 'none') {
                win.style.display = 'block';
                win.style.left = '80px';
                win.style.top = '70px';
                initBlackjack();
                bjNewGame();
            } else {
                win.style.display = 'none';
            }
        }

        // ============ MASTERMIND GAME ============
        let mm = null;

        function initMastermind() {
            mm = {
                secret: '',
                guesses: [],
                gameOver: false,
                won: false,
                gamesPlayed: 0,
                gamesWon: 0,
                totalGuesses: 0
            };
            // Generate 5-digit secret using digits 0-7
            mm.secret = '';
            for (let i = 0; i < 5; i++) {
                mm.secret += Math.floor(Math.random() * 8).toString();
            }
            mm.guesses = [];
            mm.gameOver = false;
            mm.won = false;
        }

        function mmGuess() {
            if (!mm) initMastermind();

            if (mm.gameOver) {
                initMastermind();
                mmUpdateDisplay();
                document.getElementById('mastermind-input').value = '';
                document.getElementById('mastermind-input').focus();
                return;
            }

            const input = document.getElementById('mastermind-input').value.trim();
            document.getElementById('mastermind-input').value = '';

            // Validate input
            if (input.length !== 5 || !/^[0-7]+$/.test(input)) {
                mmUpdateDisplay('USE 5 DIGITS (0-7 ONLY)');
                document.getElementById('mastermind-input').focus();
                return;
            }

            // Calculate result
            let exact = 0;  // + correct position
            let close = 0;  // - wrong position
            const secretArr = mm.secret.split('');
            const guessArr = input.split('');
            const secretUsed = [false, false, false, false, false];
            const guessUsed = [false, false, false, false, false];

            // First pass: find exact matches
            for (let i = 0; i < 5; i++) {
                if (guessArr[i] === secretArr[i]) {
                    exact++;
                    secretUsed[i] = true;
                    guessUsed[i] = true;
                }
            }

            // Second pass: find close matches
            for (let i = 0; i < 5; i++) {
                if (guessUsed[i]) continue;
                for (let j = 0; j < 5; j++) {
                    if (secretUsed[j]) continue;
                    if (guessArr[i] === secretArr[j]) {
                        close++;
                        secretUsed[j] = true;
                        break;
                    }
                }
            }

            // Build result string
            let result = '+'.repeat(exact) + '-'.repeat(close);
            if (result === '') result = '(none)';

            mm.guesses.push({ guess: input, result: result, exact: exact, close: close });

            // Check for win
            if (exact === 5) {
                mm.gameOver = true;
                mm.won = true;
                mm.gamesPlayed++;
                mm.gamesWon++;
                mm.totalGuesses += mm.guesses.length;
                mmUpdateDisplay('*** YOU WIN! ***');
            } else if (mm.guesses.length >= 10) {
                mm.gameOver = true;
                mm.gamesPlayed++;
                mmUpdateDisplay('GAME OVER! Code: ' + mm.secret);
            } else {
                mmUpdateDisplay();
                document.getElementById('mastermind-input').focus();
            }
        }

        function mmUpdateDisplay(message) {
            let out = '      MASTERMIND\n';
            out += '  ====================\n';
            out += '  GUESS A 5-DIGIT CODE\n';
            out += '  USING DIGITS 0-7\n\n';
            out += '  + = RIGHT PLACE\n';
            out += '  - = WRONG PLACE\n\n';

            if (mm.guesses.length > 0) {
                out += '  # | GUESS | RESULT\n';
                out += '  --+-------+-------\n';
                for (let i = 0; i < mm.guesses.length; i++) {
                    const g = mm.guesses[i];
                    const num = (i + 1).toString().padStart(2, '0');
                    out += '  ' + num + '| ' + g.guess + ' | ' + g.result + '\n';
                }
                out += '\n';
            }

            if (message) {
                out += '  ' + message + '\n';
            }

            if (mm.gameOver) {
                out += '\n  [OK] FOR NEW GAME';
            }

            if (mm.gamesPlayed > 0) {
                const avg = (mm.totalGuesses / mm.gamesWon).toFixed(1);
                out += '\n\n  WON: ' + mm.gamesWon + '/' + mm.gamesPlayed;
                if (mm.gamesWon > 0) out += ' AVG: ' + avg;
            }

            document.getElementById('mastermind-output').textContent = out;
        }

        function toggleMastermind() {
            const win = document.getElementById('mastermind-window');
            if (win.style.display === 'none') {
                win.style.display = 'block';
                win.style.left = '100px';
                win.style.top = '80px';
                initMastermind();
                mmUpdateDisplay();
                document.getElementById('mastermind-input').value = '';
                document.getElementById('mastermind-input').focus();
            } else {
                win.style.display = 'none';
            }
        }

        // Enter key support for Mastermind
        document.getElementById('mastermind-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                mmGuess();
            }
        });

        // ============ HAMURABI GAME ============
        let ham = null;

        function initHamurabi() {
            ham = {
                year: 1,
                population: 100,
                acres: 1000,
                bushels: 2800,
                harvest: 3,
                rats: 200,
                landPrice: 17 + Math.floor(Math.random() * 10),
                starved: 0,
                immigrants: 5,
                totalStarved: 0,
                totalYears: 0,
                phase: 'buy',
                fed: 0,
                planted: 0,
                plague: false,
                gameOver: false
            };
        }

        function hamUpdateDisplay(message) {
            const out = document.getElementById('hamurabi-output');
            const label = document.getElementById('hamurabi-label');
            let text = '      HAMURABI\n';
            text += '==================\n';

            if (ham.gameOver) {
                out.textContent = text + message;
                label.textContent = '';
                document.getElementById('hamurabi-input').style.display = 'none';
                return;
            }

            if (ham.year === 1 && ham.phase === 'buy') {
                text += 'YEAR 1 OF YOUR REIGN\n\n';
                text += 'POPULATION: ' + ham.population + '\n';
                text += 'ACRES: ' + ham.acres + '\n';
                text += 'BUSHELS: ' + ham.bushels + '\n\n';
            } else {
                text += 'YEAR ' + ham.year + ' OF YOUR REIGN\n\n';
                text += 'IN THE PREVIOUS YEAR:\n';
                text += '  ' + ham.starved + ' PEOPLE STARVED\n';
                text += '  ' + ham.immigrants + ' CAME TO THE CITY\n';
                if (ham.plague) {
                    text += '  A PLAGUE KILLED HALF!\n';
                }
                text += '  HARVEST: ' + ham.harvest + ' BU/ACRE\n';
                text += '  RATS ATE: ' + ham.rats + ' BUSHELS\n\n';
                text += 'POPULATION: ' + ham.population + '\n';
                text += 'ACRES: ' + ham.acres + '\n';
                text += 'BUSHELS: ' + ham.bushels + '\n\n';
            }

            if (message) {
                text += message + '\n\n';
            }

            document.getElementById('hamurabi-input').style.display = '';

            if (ham.phase === 'buy') {
                text += 'LAND IS ' + ham.landPrice + ' BU/ACRE\n';
                text += 'HOW MANY ACRES TO BUY?\n';
                text += '(NEGATIVE TO SELL)';
                label.textContent = 'ACRES:';
            } else if (ham.phase === 'feed') {
                text += 'HOW MANY BUSHELS TO\n';
                text += 'FEED YOUR PEOPLE?';
                label.textContent = 'BUSHELS:';
            } else if (ham.phase === 'plant') {
                text += 'HOW MANY ACRES TO PLANT?';
                label.textContent = 'ACRES:';
            }

            out.textContent = text;
            out.scrollTop = out.scrollHeight;
        }

        function hamSubmit() {
            if (ham.gameOver) {
                initHamurabi();
                hamUpdateDisplay();
                document.getElementById('hamurabi-input').value = '';
                return;
            }

            const input = document.getElementById('hamurabi-input');
            const val = parseInt(input.value) || 0;
            input.value = '';

            if (ham.phase === 'buy') {
                if (val > 0) {
                    const cost = val * ham.landPrice;
                    if (cost > ham.bushels) {
                        hamUpdateDisplay('NOT ENOUGH GRAIN!');
                        return;
                    }
                    ham.acres += val;
                    ham.bushels -= cost;
                } else if (val < 0) {
                    const sell = Math.abs(val);
                    if (sell > ham.acres) {
                        hamUpdateDisplay('NOT ENOUGH LAND!');
                        return;
                    }
                    ham.acres -= sell;
                    ham.bushels += sell * ham.landPrice;
                }
                ham.phase = 'feed';
                hamUpdateDisplay();
            } else if (ham.phase === 'feed') {
                if (val < 0) {
                    hamUpdateDisplay('INVALID AMOUNT!');
                    return;
                }
                if (val > ham.bushels) {
                    hamUpdateDisplay('NOT ENOUGH GRAIN!');
                    return;
                }
                ham.fed = val;
                ham.bushels -= val;
                ham.phase = 'plant';
                hamUpdateDisplay();
            } else if (ham.phase === 'plant') {
                if (val < 0) {
                    hamUpdateDisplay('INVALID AMOUNT!');
                    return;
                }
                if (val > ham.acres) {
                    hamUpdateDisplay('NOT ENOUGH LAND!');
                    return;
                }
                if (val > ham.bushels) {
                    hamUpdateDisplay('NOT ENOUGH SEED!');
                    return;
                }
                if (val > ham.population * 10) {
                    hamUpdateDisplay('NOT ENOUGH WORKERS!\n(EACH CAN FARM 10 ACRES)');
                    return;
                }
                ham.planted = val;
                ham.bushels -= val;
                hamEndYear();
            }
        }

        function hamEndYear() {
            ham.harvest = 1 + Math.floor(Math.random() * 6);
            const harvested = ham.planted * ham.harvest;
            ham.bushels += harvested;

            if (Math.random() < 0.4) {
                ham.rats = Math.floor(ham.bushels * (Math.random() * 0.3));
                ham.bushels -= ham.rats;
            } else {
                ham.rats = 0;
            }

            const peopleFed = Math.floor(ham.fed / 20);
            ham.starved = Math.max(0, ham.population - peopleFed);
            ham.totalStarved += ham.starved;
            ham.totalYears++;

            if (ham.starved > ham.population * 0.45) {
                ham.gameOver = true;
                hamUpdateDisplay('YOU STARVED ' + ham.starved + ' PEOPLE!\n\nDUE TO EXTREME MISMANAGEMENT\nYOU HAVE BEEN IMPEACHED AND\nTHROWN OUT OF OFFICE!\n\n[CLICK OK TO PLAY AGAIN]');
                return;
            }

            ham.population -= ham.starved;

            ham.plague = Math.random() < 0.15;
            if (ham.plague) {
                ham.population = Math.floor(ham.population / 2);
            }

            ham.immigrants = Math.floor(Math.random() * (20 * ham.acres + ham.bushels) / ham.population / 100 + 1);
            ham.immigrants = Math.min(ham.immigrants, 50);
            ham.population += ham.immigrants;

            ham.year++;
            ham.landPrice = 17 + Math.floor(Math.random() * 10);
            ham.phase = 'buy';

            if (ham.year > 10) {
                hamFinalScore();
                return;
            }

            hamUpdateDisplay();
        }

        function hamFinalScore() {
            ham.gameOver = true;
            const avgStarved = ham.totalStarved / ham.totalYears;
            const landPerPerson = ham.acres / ham.population;

            let text = 'AFTER 10 YEARS YOUR REIGN\n';
            text += 'HAS COME TO AN END.\n\n';
            text += 'POPULATION: ' + ham.population + '\n';
            text += 'ACRES: ' + ham.acres + '\n';
            text += 'BUSHELS: ' + ham.bushels + '\n\n';
            text += 'AVG STARVED/YEAR: ' + avgStarved.toFixed(1) + '\n';
            text += 'ACRES/PERSON: ' + landPerPerson.toFixed(1) + '\n\n';

            if (avgStarved > 33 || landPerPerson < 7) {
                text += 'HEAVY TAXES AND FAMINE\n';
                text += 'MARKED YOUR CRUEL REIGN.\n';
                text += 'THE PEOPLE CHEER AS YOU\n';
                text += 'ARE DRAGGED THROUGH THE\n';
                text += 'STREETS!';
            } else if (avgStarved > 10 || landPerPerson < 9) {
                text += 'YOUR HEAVY-HANDED METHODS\n';
                text += 'CAUSED MUCH DISCONTENT.\n';
                text += 'YOUR MEMORY WILL BE CURSED.';
            } else if (avgStarved > 3 || landPerPerson < 10) {
                text += 'YOUR ADMINISTRATION WAS\n';
                text += 'ADEQUATE. FEW WOULD HAVE\n';
                text += 'DONE BETTER.';
            } else {
                text += 'A FANTASTIC PERFORMANCE!\n';
                text += 'CHARLEMAGNE, DISRAELI, AND\n';
                text += 'JEFFERSON COULD NOT HAVE\n';
                text += 'DONE BETTER!';
            }

            text += '\n\n[CLICK OK TO PLAY AGAIN]';
            hamUpdateDisplay(text);
        }

        function toggleHamurabi() {
            const win = document.getElementById('hamurabi-window');
            if (win.style.display === 'none') {
                win.style.display = 'block';
                win.style.left = '120px';
                win.style.top = '60px';
                initHamurabi();
                hamUpdateDisplay();
                document.getElementById('hamurabi-input').value = '';
                document.getElementById('hamurabi-input').focus();
            } else {
                win.style.display = 'none';
            }
        }

        // Enter key support for Hamurabi
        document.getElementById('hamurabi-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                hamSubmit();
            }
        });

        // ============ MENU BAR CLOCK ============
        function updateClock() {
            const now = new Date();
            let hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12 || 12;
            document.getElementById('menu-clock').textContent = hours + ':' + minutes + ' ' + ampm;
        }
        updateClock();
        setInterval(updateClock, 1000);

        function showDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateStr = now.toLocaleDateString('en-US', options);
            showAlert(dateStr);
        }

        // ============ STARTUP ============
        window.addEventListener('load', function() {
            setTimeout(function() {
                document.getElementById('startup-screen').classList.add('fade-out');
                setTimeout(function() {
                    document.getElementById('startup-screen').classList.add('hidden');
                    centerWindow(document.getElementById('main-window'));
                }, 500);
            }, 1200);
        });

        // ============ WINDOW DRAGGING ============
        function makeDraggable(windowEl, handleEl) {
            let isDragging = false;
            let startX, startY, initialX, initialY;

            function startDrag(clientX, clientY) {
                isDragging = true;
                startX = clientX;
                startY = clientY;
                const rect = windowEl.getBoundingClientRect();
                initialX = rect.left;
                initialY = rect.top;
                windowEl.style.margin = '0';
                windowEl.style.transform = 'none';
                windowEl.style.left = initialX + 'px';
                windowEl.style.top = initialY + 'px';
            }

            function moveDrag(clientX, clientY) {
                if (!isDragging) return;
                const dx = clientX - startX;
                const dy = clientY - startY;
                windowEl.style.left = (initialX + dx) + 'px';
                windowEl.style.top = (initialY + dy) + 'px';
            }

            function endDrag() {
                isDragging = false;
            }

            // Mouse events
            handleEl.addEventListener('mousedown', function(e) {
                if (e.target.classList.contains('close') || e.target.classList.contains('resize')) return;
                startDrag(e.clientX, e.clientY);
            });

            document.addEventListener('mousemove', function(e) {
                moveDrag(e.clientX, e.clientY);
            });

            document.addEventListener('mouseup', endDrag);

            // Touch events
            handleEl.addEventListener('touchstart', function(e) {
                if (e.target.classList.contains('close') || e.target.classList.contains('resize')) return;
                const touch = e.touches[0];
                startDrag(touch.clientX, touch.clientY);
            }, { passive: true });

            document.addEventListener('touchmove', function(e) {
                if (!isDragging) return;
                e.preventDefault();
                const touch = e.touches[0];
                moveDrag(touch.clientX, touch.clientY);
            }, { passive: false });

            document.addEventListener('touchend', endDrag);

            // Double-click to collapse/expand (window shade)
            handleEl.addEventListener('dblclick', function(e) {
                if (e.target.classList.contains('close') || e.target.classList.contains('resize')) return;
                windowEl.classList.toggle('collapsed');
            });
        }

        // Initialize draggable windows
        makeDraggable(document.getElementById('main-window'), document.getElementById('title-bar'));
        makeDraggable(document.getElementById('calculator-window'), document.getElementById('calc-title-bar'));
        makeDraggable(document.getElementById('puzzle-window'), document.getElementById('puzzle-title-bar'));
        makeDraggable(document.getElementById('notepad-window'), document.getElementById('notepad-title-bar'));
        makeDraggable(document.getElementById('email-window'), document.getElementById('email-title-bar'));
        makeDraggable(document.getElementById('search-window'), document.getElementById('search-title-bar'));
        makeDraggable(document.getElementById('lander-window'), document.getElementById('lander-title-bar'));
        makeDraggable(document.getElementById('startrek-window'), document.getElementById('startrek-title-bar'));
        makeDraggable(document.getElementById('blackjack-window'), document.getElementById('blackjack-title-bar'));
        makeDraggable(document.getElementById('mastermind-window'), document.getElementById('mastermind-title-bar'));
        makeDraggable(document.getElementById('hamurabi-window'), document.getElementById('hamurabi-title-bar'));

        // Enter key support for search
        document.getElementById('search-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                searchGoogle();
            }
        });

        // Enter key support for lander
        document.getElementById('lander-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                landerBurn();
            }
        });

        // ============ WINDOW FUNCTIONS ============
        function centerWindow(windowEl) {
            const rect = windowEl.getBoundingClientRect();
            windowEl.style.margin = '0';
            windowEl.style.left = ((window.innerWidth - rect.width) / 2) + 'px';
            windowEl.style.top = (60 + (window.innerHeight - 60 - rect.height) / 3) + 'px';
        }

        let trashHasItems = false;

        function closeMainWindow() {
            const win = document.getElementById('main-window');
            win.style.display = 'none';
            trashHasItems = true;
            document.getElementById('trash-icon').classList.add('has-items');
        }

        function closeAllWindows() {
            const windows = ['main-window', 'calculator-window', 'puzzle-window', 'notepad-window', 'email-window', 'search-window', 'lander-window', 'startrek-window', 'blackjack-window', 'mastermind-window', 'hamurabi-window'];
            windows.forEach(function(id) {
                document.getElementById(id).style.display = 'none';
            });
            trashHasItems = true;
            document.getElementById('trash-icon').classList.add('has-items');
        }

        function showMainWindow() {
            const win = document.getElementById('main-window');
            win.style.display = 'block';
            win.classList.remove('collapsed');
            centerWindow(win);
        }

        function showAboutBen(e) {
            e.preventDefault();
            showMainWindow();
        }

        function emptyTrash() {
            if (trashHasItems) {
                showMainWindow();
                trashHasItems = false;
                document.getElementById('trash-icon').classList.remove('has-items');
            } else {
                showAlert('The Trash is already empty.');
            }
        }

        // ============ MODAL FUNCTIONS ============
        function showModal(id) {
            document.getElementById(id).classList.add('visible');
        }

        function hideModal(id) {
            document.getElementById(id).classList.remove('visible');
        }

        function showAlert(message) {
            document.getElementById('alert-text').textContent = message;
            showModal('alert-modal');
        }

        function showAboutMac(e) {
            e.preventDefault();
            e.stopPropagation();
            showModal('about-mac-modal');
        }

        function showFindDialog() {
            showModal('find-modal');
            document.getElementById('find-input').focus();
        }

        function doFind() {
            const query = document.getElementById('find-input').value;
            if (query) {
                window.find(query);
            }
            hideModal('find-modal');
        }

        // ============ ZOOM FUNCTIONS ============
        let currentZoom = 1;
        function applyZoom() {
            document.querySelectorAll('.window').forEach(function(w) {
                w.style.transform = 'scale(' + currentZoom + ')';
            });
        }
        function zoomIn() {
            currentZoom = Math.min(currentZoom + 0.1, 2);
            applyZoom();
        }
        function zoomOut() {
            currentZoom = Math.max(currentZoom - 0.1, 0.5);
            applyZoom();
        }

        // ============ SPECIAL MENU FUNCTIONS ============
        function cleanUp() {
            // Clean up windows
            const windows = ['main-window', 'calculator-window', 'puzzle-window', 'notepad-window', 'email-window', 'search-window', 'lander-window', 'startrek-window', 'blackjack-window', 'mastermind-window', 'hamurabi-window'];
            let offset = 0;
            windows.forEach(function(id) {
                const win = document.getElementById(id);
                if (win.style.display !== 'none') {
                    win.style.transition = 'all 0.3s ease';
                    centerWindow(win);
                    win.style.top = (parseInt(win.style.top) + offset) + 'px';
                    offset += 30;
                    setTimeout(function() {
                        win.style.transition = '';
                    }, 300);
                }
            });

            // Reset desktop icons to original positions
            const iconPositions = {
                'hd-icon': { right: '10px', top: '10px', left: '', bottom: '' },
                'email-icon': { left: '10px', top: '10px', right: '', bottom: '' },
                'internet-icon': { left: '10px', top: '90px', right: '', bottom: '' },
                'trash-icon': { right: '10px', bottom: '10px', left: '', top: '' }
            };
            Object.keys(iconPositions).forEach(function(id) {
                const icon = document.getElementById(id);
                if (icon) {
                    icon.style.transition = 'all 0.3s ease';
                    const pos = iconPositions[id];
                    icon.style.left = pos.left;
                    icon.style.right = pos.right;
                    icon.style.top = pos.top;
                    icon.style.bottom = pos.bottom;
                    setTimeout(function() {
                        icon.style.transition = '';
                    }, 300);
                }
            });
        }

        function restartSystem() {
            hideModal('bomb-modal');
            document.body.classList.add('fade-out');
            setTimeout(function() {
                location.reload();
            }, 500);
        }

        function shutDown() {
            const shutdownScreen = document.createElement('div');
            shutdownScreen.id = 'shutdown-screen';
            shutdownScreen.style.cssText = 'background:black;color:white;font-family:Chicago,ChiKareGo2,monospace;padding:2rem;text-align:center;position:fixed;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:2rem;z-index:10001;cursor:pointer;';
            shutdownScreen.innerHTML = '<div>It is now safe to turn off<br>your computer.</div><div style="font-size:12px;">(click to restart)</div>';
            shutdownScreen.onclick = function() { location.reload(); };
            document.body.appendChild(shutdownScreen);
        }

        // ============ CALCULATOR ============
        let calcValue = '0';

        function toggleCalculator() {
            const calc = document.getElementById('calculator-window');
            if (calc.style.display === 'none') {
                calc.style.display = 'block';
                calc.style.left = '50px';
                calc.style.top = '100px';
            } else {
                calc.style.display = 'none';
            }
        }

        function updateCalcDisplay() {
            document.getElementById('calc-display').textContent = calcValue;
        }

        function calcInput(val) {
            if (calcValue === '0' && !isNaN(val)) {
                calcValue = val;
            } else {
                calcValue += val;
            }
            updateCalcDisplay();
        }

        function calcClear() {
            calcValue = '0';
            updateCalcDisplay();
        }

        function calcBackspace() {
            calcValue = calcValue.slice(0, -1) || '0';
            updateCalcDisplay();
        }

        function calcEquals() {
            try {
                calcValue = String(eval(calcValue));
                if (calcValue === 'Infinity' || calcValue === 'NaN') {
                    calcValue = 'Error';
                }
            } catch (e) {
                calcValue = 'Error';
            }
            updateCalcDisplay();
        }

        // ============ PUZZLE ============
        let puzzleTiles = [];

        function initPuzzle() {
            puzzleTiles = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 0];
            renderPuzzle();
        }

        function renderPuzzle() {
            const grid = document.getElementById('puzzle-grid');
            grid.innerHTML = '';
            puzzleTiles.forEach(function(tile, index) {
                const div = document.createElement('div');
                div.className = 'puzzle-tile' + (tile === 0 ? ' empty' : '');
                div.textContent = tile === 0 ? '' : tile;
                if (tile !== 0) {
                    div.onclick = function() { moveTile(index); };
                }
                grid.appendChild(div);
            });
        }

        function moveTile(index) {
            const emptyIndex = puzzleTiles.indexOf(0);
            const validMoves = [index - 1, index + 1, index - 4, index + 4];

            // Check if move is valid (adjacent to empty)
            if (validMoves.includes(emptyIndex)) {
                // Check not wrapping around edges
                if ((index % 4 === 0 && emptyIndex === index - 1) ||
                    (index % 4 === 3 && emptyIndex === index + 1)) {
                    return;
                }
                // Swap
                puzzleTiles[emptyIndex] = puzzleTiles[index];
                puzzleTiles[index] = 0;
                renderPuzzle();
                checkPuzzleWin();
            }
        }

        function shufflePuzzle() {
            // Perform random valid moves
            for (let i = 0; i < 100; i++) {
                const emptyIndex = puzzleTiles.indexOf(0);
                const moves = [];
                if (emptyIndex >= 4) moves.push(emptyIndex - 4);
                if (emptyIndex < 12) moves.push(emptyIndex + 4);
                if (emptyIndex % 4 !== 0) moves.push(emptyIndex - 1);
                if (emptyIndex % 4 !== 3) moves.push(emptyIndex + 1);
                const randomMove = moves[Math.floor(Math.random() * moves.length)];
                puzzleTiles[emptyIndex] = puzzleTiles[randomMove];
                puzzleTiles[randomMove] = 0;
            }
            renderPuzzle();
        }

        function checkPuzzleWin() {
            const winning = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 0];
            if (puzzleTiles.every((tile, i) => tile === winning[i])) {
                setTimeout(function() {
                    showModal('puzzle-win-modal');
                }, 300);
            }
        }

        function togglePuzzle() {
            const puzzle = document.getElementById('puzzle-window');
            if (puzzle.style.display === 'none') {
                puzzle.style.display = 'block';
                puzzle.style.left = '100px';
                puzzle.style.top = '80px';
                if (puzzleTiles.length === 0) {
                    initPuzzle();
                    shufflePuzzle();
                }
            } else {
                puzzle.style.display = 'none';
            }
        }

        // ============ NOTE PAD ============
        let notepadPages = ['', '', '', '', '', '', '', ''];
        let currentNotePage = 0;

        function toggleNotePad() {
            const notepad = document.getElementById('notepad-window');
            if (notepad.style.display === 'none') {
                notepad.style.display = 'block';
                notepad.style.left = '150px';
                notepad.style.top = '120px';
                loadNotepadFromStorage();
                updateNotepadDisplay();
            } else {
                saveCurrentNotePage();
                notepad.style.display = 'none';
            }
        }

        function saveCurrentNotePage() {
            notepadPages[currentNotePage] = document.getElementById('notepad-textarea').value;
            localStorage.setItem('notepadPages', JSON.stringify(notepadPages));
        }

        function loadNotepadFromStorage() {
            const saved = localStorage.getItem('notepadPages');
            if (saved) {
                notepadPages = JSON.parse(saved);
            }
        }

        function updateNotepadDisplay() {
            document.getElementById('notepad-textarea').value = notepadPages[currentNotePage];
            document.getElementById('notepad-page-num').textContent = currentNotePage + 1;
        }

        function nextNotePage() {
            saveCurrentNotePage();
            currentNotePage = (currentNotePage + 1) % notepadPages.length;
            updateNotepadDisplay();
        }

        // Auto-save on input
        document.getElementById('notepad-textarea').addEventListener('input', function() {
            notepadPages[currentNotePage] = this.value;
            localStorage.setItem('notepadPages', JSON.stringify(notepadPages));
        });

        // ============ EASTER EGGS ============
        const konamiCode = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'KeyB', 'KeyA'];
        let konamiIndex = 0;

        document.addEventListener('keydown', function(e) {
            // Konami code
            if (e.code === konamiCode[konamiIndex]) {
                konamiIndex++;
                if (konamiIndex === konamiCode.length) {
                    showModal('konami-modal');
                    konamiIndex = 0;
                }
            } else {
                konamiIndex = 0;
            }

            // Secret bomb trigger: Ctrl+Shift+B
            if (e.ctrlKey && e.shiftKey && e.code === 'KeyB') {
                showModal('bomb-modal');
            }

            // Sad Mac trigger: Ctrl+Shift+S
            if (e.ctrlKey && e.shiftKey && e.code === 'KeyS') {
                e.preventDefault();
                document.getElementById('sad-mac-screen').classList.add('visible');
            }
        });

        // ============ CLICK OUTSIDE TO CLOSE MODALS ============
        document.querySelectorAll('.modal-overlay').forEach(function(overlay) {
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    overlay.classList.remove('visible');
                }
            });
        });

        // ============ DESKTOP ICON SELECTION & DRAGGING ============
        const GRID_SIZE = 80;
        const GRID_PADDING = 10;

        function snapToGrid(value) {
            return Math.round((value - GRID_PADDING) / GRID_SIZE) * GRID_SIZE + GRID_PADDING;
        }

        document.querySelectorAll('.desktop-icon').forEach(function(icon) {
            let isDragging = false;
            let hasMoved = false;
            let startX, startY, iconStartX, iconStartY;
            let clickTimeout;

            icon.addEventListener('mousedown', function(e) {
                if (e.button !== 0) return;
                e.preventDefault();

                // Capture position from bounding rect BEFORE modifying styles
                const rect = icon.getBoundingClientRect();
                const gridRect = document.getElementById('desktop-grid').getBoundingClientRect();
                const leftPos = rect.left - gridRect.left;
                const topPos = rect.top - gridRect.top;

                isDragging = true;
                hasMoved = false;
                icon.classList.add('dragging');

                startX = e.clientX;
                startY = e.clientY;
                iconStartX = leftPos;
                iconStartY = topPos;

                // Convert to left/top positioning
                icon.style.left = leftPos + 'px';
                icon.style.top = topPos + 'px';
                icon.style.right = '';
                icon.style.bottom = '';
            });

            icon.addEventListener('click', function(e) {
                if (hasMoved) {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
                document.querySelectorAll('.desktop-icon').forEach(i => i.classList.remove('selected'));
                this.classList.add('selected');
            });

            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;

                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;

                if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
                    hasMoved = true;
                }

                const gridRect = document.getElementById('desktop-grid').getBoundingClientRect();
                let newX = iconStartX + deltaX;
                let newY = iconStartY + deltaY;

                // Constrain to grid bounds
                newX = Math.max(GRID_PADDING, Math.min(newX, gridRect.width - GRID_SIZE - GRID_PADDING));
                newY = Math.max(GRID_PADDING, Math.min(newY, gridRect.height - GRID_SIZE - GRID_PADDING));

                icon.style.left = newX + 'px';
                icon.style.top = newY + 'px';
            });

            document.addEventListener('mouseup', function(e) {
                if (!isDragging) return;
                isDragging = false;
                icon.classList.remove('dragging');

                if (hasMoved) {
                    // Snap to grid
                    const gridRect = document.getElementById('desktop-grid').getBoundingClientRect();
                    let currentX = parseFloat(icon.style.left);
                    let currentY = parseFloat(icon.style.top);

                    icon.style.left = snapToGrid(currentX) + 'px';
                    icon.style.top = snapToGrid(currentY) + 'px';
                }
            });

            // Touch support for mobile
            icon.addEventListener('touchstart', function(e) {
                const touch = e.touches[0];
                isDragging = true;
                hasMoved = false;
                icon.classList.add('dragging');

                const rect = icon.getBoundingClientRect();
                const gridRect = document.getElementById('desktop-grid').getBoundingClientRect();

                startX = touch.clientX;
                startY = touch.clientY;
                iconStartX = rect.left - gridRect.left;
                iconStartY = rect.top - gridRect.top;

                icon.style.left = iconStartX + 'px';
                icon.style.top = iconStartY + 'px';
                icon.style.right = '';
                icon.style.bottom = '';
            }, { passive: true });

            icon.addEventListener('touchmove', function(e) {
                if (!isDragging) return;
                const touch = e.touches[0];

                const deltaX = touch.clientX - startX;
                const deltaY = touch.clientY - startY;

                if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
                    hasMoved = true;
                }

                const gridRect = document.getElementById('desktop-grid').getBoundingClientRect();
                let newX = iconStartX + deltaX;
                let newY = iconStartY + deltaY;

                newX = Math.max(GRID_PADDING, Math.min(newX, gridRect.width - GRID_SIZE - GRID_PADDING));
                newY = Math.max(GRID_PADDING, Math.min(newY, gridRect.height - GRID_SIZE - GRID_PADDING));

                icon.style.left = newX + 'px';
                icon.style.top = newY + 'px';
            }, { passive: true });

            icon.addEventListener('touchend', function(e) {
                if (!isDragging) return;
                isDragging = false;
                icon.classList.remove('dragging');

                if (hasMoved) {
                    const gridRect = document.getElementById('desktop-grid').getBoundingClientRect();
                    let currentX = parseFloat(icon.style.left);
                    let currentY = parseFloat(icon.style.top);

                    icon.style.left = snapToGrid(currentX) + 'px';
                    icon.style.top = snapToGrid(currentY) + 'px';
                }
            });
        });

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.desktop-icon')) {
                document.querySelectorAll('.desktop-icon').forEach(i => i.classList.remove('selected'));
            }
        });

        // ============ MOBILE MENU HANDLING ============
        (function() {
            const menuItems = document.querySelectorAll('ul[role="menu-bar"] > [role="menu-item"][aria-haspopup="true"]');

            function closeAllMenus() {
                menuItems.forEach(function(item) {
                    item.classList.remove('menu-open');
                });
            }

            menuItems.forEach(function(menuItem) {
                menuItem.addEventListener('click', function(e) {
                    // Don't toggle if clicking on a submenu link
                    if (e.target.closest('ul[role="menu"] a')) {
                        closeAllMenus();
                        return;
                    }

                    e.preventDefault();
                    e.stopPropagation();

                    const isOpen = this.classList.contains('menu-open');
                    closeAllMenus();

                    if (!isOpen) {
                        this.classList.add('menu-open');
                    }
                });
            });

            // Close menus when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('ul[role="menu-bar"]')) {
                    closeAllMenus();
                }
            });

            // Close menus when touching outside on mobile
            document.addEventListener('touchstart', function(e) {
                if (!e.target.closest('ul[role="menu-bar"]')) {
                    closeAllMenus();
                }
            }, { passive: true });
        })();
    </script>
</body>
</html>
